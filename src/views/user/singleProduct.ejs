
<div class="py-3 px-4">
    <!-- Main Product Container - Large like Hero Carousel -->
    <div class="carousel-container bg-gray-50  mx-4 sm:mx-4 my-5 mt-3 rounded-[2rem] sm:rounded-[5.5rem] relative  ">
        <div>
            <!-- Product Overview Section -->
            <div class=" grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-10 p-14 sm:p-10 lg:pb-12 lg:pl-12 lg:pr-12 ">
                
                <!-- Left Column - Product Images -->
                <div class="flex justify-center items-start rounded-[1.5rem]  sm:rounded-[5rem] bg-white shadow-gray-200 shadow-[0_0_20px_rgba(0,0,0,0.25)]">
                    <div class="  max-w-lg relative ">
                        <!-- Main Product Image -->
                        <div class="mb-3 rounded-[1.5rem] sm:rounded-[5rem] overflow-visible p-4">
                            <img id="main-image" 
                                 src="<%= product.variants[0].attributes.productImages[0] %>" 
                                 data-zoom-image="<%= product.variants[0].attributes.productImages[0] %>" 
                                 alt="<%= product.name %>" 
                                 class="w-full h-auto object-contain pt-2 pl-4 pr-4 transition-all duration-500 rounded-[1.5rem] sm:rounded-[5rem]">
                        </div>
                        
                        <!-- Thumbnail Images -->
                        <div id="thumbnailContainer" class="grid grid-cols-5 gap-2 mb-3">
                            <% for (let i = 0; i < 5 && i < product.variants[0].attributes.productImages.length; i++) { %>
                              <button 
                                type="button"
                                class="thumbnail <%= i === 0 ? 'active' : '' %> cursor-pointer rounded-[2rem] overflow-hidden
                                        border-transparent focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-0 transition-all duration-300"
                                onclick="changeImage('<%= product.variants[0].attributes.productImages[i] %>', this)">
                                <img src="<%= product.variants[0].attributes.productImages[i] %>" 
                                     alt="Thumbnail <%= i + 1 %>" 
                                     class="w-full h-auto object-cover aspect-square">
                              </button>
                            <% } %>
                          </div>
                          
                    </div>
                </div>

                <!-- Right Column - Product Details -->
                <div class="flex flex-col justify-center space-y-5 space-x-14 rounded-[1.5rem] sm:rounded-[5rem] bg-white shadow-gray-200 shadow-[0_0_20px_rgba(0,0,0,0.25)]">
                    <div class="pl-20">
                        <p class="text-gray-400 tracking-widest pt-2 pb-4 font-sans text-lg"><%= product.brand %></p>
                        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-gray-800 mt-2 leading-tight tracking-wide">
                            <%= product.name %>
                        </h1>
                        <p class="text-gray-600 text-lg mt-3"><%= product.productDetails.driverConfiguration %> driver</p>
                    </div>

                    <div class="rounded-2xl pl-6 ">
                        <div class="flex items-center mb-2">
                            <span id="discountedPrice" class="text-4xl font-bold font-sans text-gray-900">
                                <%= Math.round(product.variants[0].attributes.price * 0.01 * (100 - product.variants[0].attributes.discount)) %> ₹
                            </span>
                            <span id="price" class="ml-3 text-xl text-gray-500 line-through"><%= product.variants[0].attributes.price %> ₹</span>
                            <span id="discount" class="ml-3 bg-black text-white px-3 py-1 rounded-full text-sm font-semibold"><%= product.variants[0].attributes.discount %> % off</span>
                        </div>
                        
                    </div>

                    <div class="space-y-6 pl-7">
                        <div>
                            <p class="text-gray-700 font-semibold mb-3 text-lg">
                                Color: <span id="selected-color" class="text-gray-900"><%= product.variants[0].attributes.color%></span>
                            </p>
                            <div class="flex space-x-5">
                                <% product.variants.forEach((variant,index)=>{ %>
                                       <div 
                                        class="variant-option <%= index === 0 ? 'active' : '' %> cursor-pointer group" 
                                        data-value="<%= variant.attributes.color %>" 
                                        data-variant-id="<%=product.variants[0].sku%>"
                                        onclick="selectVariant(this, 'color')">

                                        <!-- Dynamic color circle -->
                                        <div 
                                            class="w-14 h-9 rounded-full border-2 
                                                <%= index === 0 ? 'border-gray-400' : 'border-gray-400' %> 
                                                group-hover:border-black transition-all duration-300 shadow-xl" 
                                            style="background-color: <%= variant.attributes.color.toLowerCase() %>">
                                        </div>

                                      
                                    </div>

                               <% }) %>
                               

                            </div>
                        </div>
                        
                        <div>
                            <p class="text-gray-700 font-semibold mb-2 text-lg">
                                Type :  <span id="selected-mic" class="text-gray-900">With Mic</span>
                            </p>
                            <div class="flex space-x-4">
                                <div id="mic-option" class="variant-option  cursor-pointer group" data-product-id= "<%=product.id %>" data-value="true" onclick="selectVariant(this, 'mic')">
                                    <div id="mic-btn" class="w-16 h-10 flex items-center justify-center <%= product.variants[0].attributes.mic==true?'bg-black':'bg-white'%> rounded-xl border-2 border-gray-200 group-hover:border-gray-600 transition-all duration-300 shadow-sm">
                                        <i id="micIcon" class="fas fa-microphone <%= product.variants[0].attributes.mic==true?'text-white':'text-black'%>"></i>
                                    </div>
                                </div>
                                <div id="mic-option" class="variant-option cursor-pointer group" data-product-id= "<%=product.id %>" data-value="false" onclick="selectVariant(this, 'mic')">
                                    <div id="mic-btn" class="w-16 h-10 flex items-center justify-center  <%= product.variants[0].attributes.mic==false?'bg-black':'bg-white'%> rounded-xl border-2 border-gray-200 group-hover:border-gray-400 transition-all duration-300 shadow-sm">
                                        <i id="noMicIcon" class="fas fa-ban <%= product.variants[0].attributes.mic==false?'text-white':'text-black'%>"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    

                    <div class="flex items-center pl-7 space-x-4 ">

                        <!-- IN STOCK BOX -->
                        <div class="min-w-[100px] h-10 flex items-center justify-center 
                                    bg-white rounded-xl border-2 border-gray-200 
                                    hover:border-gray-600 transition-all duration-300 shadow-sm">
                            <span id="stockIndicator" class="text-green-700 font-semibold text-sm"><%=product.variants[0].attributes.stock>0?'In Stock':'Out Of Stock'%></span>
                        </div>
                    
                        <!-- STOCK COUNT BOX -->
                        <div class="min-w-[100px] h-10 flex items-center justify-center 
                                    bg-white rounded-xl border-2 border-gray-200 
                                    hover:border-gray-600 transition-all duration-300 shadow-sm">
                            <span id="stock" class="text-gray-700 font-medium text-sm">
                                <%= product.variants[0].attributes.stock %> units
                            </span>
                        </div>
                    
                        <div class="relative inline-flex items-center group">

                            <!-- COUPON ICON BUTTON -->
                            <div id="coupon-btn"
                                 class="peer min-w-[60px] h-10 flex items-center justify-center 
                                        bg-white rounded-xl border-2 border-gray-200 
                                        hover:border-gray-600 transition-all duration-300 shadow-sm cursor-pointer">
                                <i class="fa-solid fa-tag fa-xl" style="color: #ababab;"></i>
                            </div>
                        
                            <!-- COPY BUTTON -->
                            <button id="copyBtn"
                                class="ml-2 px-4 h-10 bg-black text-white rounded-xl shadow-sm text-sm
                                       opacity-0 pointer-events-none
                                       transition-all duration-200
                        
                                       peer-hover:opacity-100 peer-hover:pointer-events-auto
                                       group-hover:opacity-100 group-hover:pointer-events-auto">
                                <span id="couponCode"></span>
                            </button>
                        
                        </div>
                        


                        
                    
                    </div>
                    

                    <div class="flex items-center justify-center flex-col sm:flex-row gap-4 pt-2 pb-8">
                        <button data-product-id= "<%=product._id %>" data-variant-id="<%=product.variants[0].sku%>" class="addToCartBtn bg-gray-800 hover:bg-black text-white font-semibold py-4 px-8 rounded-xl flex items-center justify-center transition-all duration-300 shadow-lg hover:shadow-xl ">
                            <i class="fas fa-shopping-cart mr-3"></i> 
                            Add to Cart
                        </button>
                        <button id="wishlistBtn" class="border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 text-gray-700 font-semibold py-4 px-8 rounded-xl flex items-center justify-center transition-all duration-300" data-variant-id="<%=product.variants[0].sku%>" data-iswishlisted="<%= product.variants[0].attributes.isWishlisted %>"  onclick="handleWishlist('<%=product._id%>',this.dataset.variantId,this)">
                            <i class="fas fa-heart mr-2" style='color: <%= product.variants[0].attributes.isWishlisted? '#000000' : '#a3a5a8'  %>; '></i>
                           <p id="wishlist-text"><%= product.variants[0].attributes.isWishlisted? 'Wishlisted' : 'Wishlist'%> </p> 
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
    
</div>

<%-//include ('cart')%> //we can remove this

<style>
.thumbnail.active {
    border-color: #3B82F6 !important;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}
.variant-option.active .w-12,

.tab-button.active {
    color: #3B82F6;
    border-bottom-color: #3B82F6 !important;
    background-color: white;
}
.carousel-container {
    overflow: visible !important;
    position: relative;
}
.mb-3.rounded-[1.5rem].sm\:rounded-[5rem] {
    overflow: visible !important;
    position: relative;
}

* {
    transition: all 0.3s ease;
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>

<script>

document.getElementById('copyBtn').addEventListener('click',async()=>{
    console.log('hihiih');
    const code = document.getElementById("couponCode").textContent.trim();
    
  try {
    await navigator.clipboard.writeText(code);
    showToast('success',"Coupon Copied");
  } catch (err) {
    console.error("Copy failed", err);
  }
})

//coupon loaded

async function getCoupons(){
    console.log('hello');
    try {
        console.log('call inside getCOupons');
        const response= await axios.get('/user/coupons')
        console.log('response',response);
        if(!response.data.coupons){
            throw new Error('Server issue')
        }
        const coupons = response.data.coupons.map((c)=>c.code);
         console.log(coupons);
        if(coupons && coupons.length>0){
            document.getElementById("couponCode").textContent=coupons[0]
         loadCoupons(coupons) 
        }
        
    } catch (error) {
        console.log('Error in getting coupon',error);
        if(error){
            document.getElementById("copyBtn").classList.add('hidden')
            document.getElementById('coupon-btn').classList.remove('border-2')
        
        }
    }
}
getCoupons()

async function loadCoupons(coupons){
    console.log('Hello');
    try {
        const codeSpan = document.getElementById("couponCode")
        

        setInterval(()=>{
            let index=Math.floor(Math.random()*(coupons.length-1))
            codeSpan.textContent=coupons[index];
            
        },10000)
    } catch (error) {
        console.log('Error in Loading Coupons',error);
    }
}

function changeImage(imageUrl, thumbnailElement) {
  const mainImage = document.getElementById('main-image');
  
  // Update the main image src and data attributes
  mainImage.style.opacity = 0;
    setTimeout(()=>{
        mainImage.src = imageUrl;
        mainImage.style.opacity = 1;
    },150)

 

  // Optional: add active class to clicked thumbnail, remove from others
  document.querySelectorAll('.thumbnail').forEach(btn => btn.classList.remove('active'));
  thumbnailElement.classList.add('active');
}

function updateVariantDetails(variant){
  
    const mainImage = document.getElementById('main-image');
    const addToCartBtn=document.querySelector('.addToCartBtn');
    const wishlistDiv = document.getElementById('wishlist-text');
   
    
    wishlistDiv.innerText = variant[0].attributes.isWishlisted?'Wishlisted':'Wishlist';
    const wishlistIcon=wishlistBtn.querySelector('.fas')
    wishlistIcon.style.color=variant[0].attributes.isWishlisted?'#000000':'#a3a5a8'; 
    addToCartBtn.dataset.variantId=variant[0].sku;
    wishlistBtn.dataset.variantId=variant[0].sku;

    // wishlist-text
    // console.log(variant[0].attributes.productImages[0]);
    // Fade out main image
    mainImage.style.opacity = 0;
    setTimeout(()=>{
        mainImage.src = variant[0].attributes.productImages[0];
        mainImage.style.opacity = 1;
    },150)
    

    
    //thumbnail images
    const thumbnailContainer = document.querySelector('#thumbnailContainer');
    console.log(thumbnailContainer);
    thumbnailContainer.innerHTML='';
    variant[0].attributes.productImages.forEach((img,i)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className=`thumbnail ${i === 0 ? 'active' : ''} cursor-pointer rounded-[2rem] overflow-hidden border-transparent focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-0 transition-all duration-300`
        btn.onclick= ()=>changeImage(img,btn);

        const thumbImg = document.createElement('img');
        thumbImg.src=img;
        thumbImg.alt = `Thumbnail ${i+1}`;
        thumbImg.className = 'w-full h-auto object-cover aspect-square';
        thumbImg.style.opacity=0;
        thumbImg.style.transition='opacity 0.3 ease-in-out'
        thumbImg.onload= ()=>{
            thumbImg.style.opacity=1;
        }
        btn.appendChild(thumbImg);
        thumbnailContainer.appendChild(btn)
    });

    const price = Math.round(variant[0].attributes.price*0.01*(100-variant[0].attributes.discount))
    document.querySelector('#discountedPrice').textContent=`${price} ₹`;
    document.querySelector('#price').textContent=`${variant[0].attributes.price} ₹`;
    document.querySelector('#discount').textContent=`${variant[0].attributes.discount} % off`;
    document.querySelector('#selected-color').textContent = variant[0].attributes.color

   const micInput= document.querySelector('#selected-mic');
   micInput.textContent = variant[0].attributes.mic===true?'With Mic':'Without Mic'

  console.log( document.querySelector('#mic-option'));

  document.querySelectorAll('#mic-btn').forEach(btn=>{
            btn.classList.remove('bg-black');
            btn.querySelector('i').classList.remove('text-white');
            btn.classList.add('bg-white');
            btn.querySelector('i').classList.add('text-black');
        })

        if(variant[0].attributes.mic===true){
            const micIcon=document.querySelector('#micIcon');
            const micBtn = micIcon.closest('#mic-btn')
            micIcon.classList.add('text-white')
            micBtn.classList.add('bg-black')
            micIcon.classList.remove('text-black')
            micBtn.classList.remove('bg-white')
        }else{
            const micIcon=document.querySelector('#noMicIcon');
            const micBtn = micIcon.closest('#mic-btn')
            micIcon.classList.remove('text-black')
            micBtn.classList.remove('bg-white')
            micIcon.classList.add('text-white')
            micBtn.classList.add('bg-black')
        }
    
    document.querySelector('#stockIndicator').textContent = `${variant[0].attributes.stock>0?'In Stock':'Out Of Stock'}`;
    document.querySelector('#stock').textContent= `${variant[0].attributes.stock} units`

}




function selectVariant(element, type) {
    const container = element.parentElement;
    const options = container.querySelectorAll('.variant-option');
    const productId =document.getElementById("mic-option").dataset.productId;

    console.log('setting variant id',productId);
    
    options.forEach(opt => opt.classList.remove('active'));
    element.classList.add('active');
    const value = element.getAttribute('data-value').toLowerCase();
    console.log(type);
    console.log(value);
    if (type === 'color') {
        document.getElementById('selected-color').textContent = value;
    } 
    // if(type === 'mic'){
    //     document.querySelectorAll('#mic-btn').forEach(btn=>{
    //         btn.classList.remove('bg-black');
    //         btn.querySelector('i').classList.remove('text-white');
    //         btn.classList.add('bg-white');
    //         btn.querySelector('i').classList.add('text-black');
    //     })

    //     element.querySelector('#mic-btn').classList.toggle('bg-black')
    //     element.querySelector('i').classList.toggle('text-white')
    // }
 
  
    
    axios.get(`/user/products/variantProduct`,{
      params:{
        productId,
        type,
        value
      }
    })
    .then((response)=>{
        const product=response.data.product;
        console.log(product);
        const variant = product.variants;
        console.log(variant)
        const addToCartBtn = document.querySelector('.addToCartBtn')
        const wishlistBtn = document.getElementById('wishlistBtn')
        addToCartBtn.disabled=false;
        addToCartBtn.classList.remove('bg-gray-500')
        addToCartBtn.classList.add('hover:bg-black')
        wishlistBtn.classList.remove('bg-gray-100')
        wishlistBtn.classList.add('hover:bg-gray-50','hover:border-gray-400')
        wishlistBtn.disabled=false
        updateVariantDetails(variant)
    })
    .catch((err)=>{
        console.log('Error in selecting variant',err);
        const message = err.response.data.customMessage;
        const mic = err.response.data.mic
        if(message) showToast('error',message);
        const addToCartBtn = document.querySelector('.addToCartBtn')
        const wishlistBtn = document.getElementById('wishlistBtn')
        addToCartBtn.setAttribute('disabled',true)
        addToCartBtn.classList.add('bg-gray-500')
        addToCartBtn.classList.remove('hover:bg-black')
        wishlistBtn.setAttribute('disabled',true)
        wishlistBtn.classList.add('bg-gray-100')
        wishlistBtn.classList.remove('hover:bg-gray-50','hover:border-gray-400')
        
        
    })
}


</script>
<script>
    //  function addToWishList(){

    //     const addToCartBtn=document.getElementById('addToCartBtn');
    //     productId=addToCartBtn.dataset.productId;
    //     variantId=addToCartBtn.dataset.variantId;
    //     console.log(productId,variantId);

    // axios.post('/user/wishlist',{productId,variantId})
    // .then((response)=>{
    //   console.log(response);
    //   const message = response.data.customMessage;
    //   showToast('success',message)
    // })
    // .catch((err)=>{
    //   console.log(err)
    //   const message = err.response.data.customMessage || 'Something Went Wrong';
    //   showToast('error',message)
    // })
    
  //}
</script>

<!-- <script src="../../../js/user/cart-script.js"></script> -->